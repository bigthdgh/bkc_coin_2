<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BKC Exchange - Professional Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .neon-glow {
            text-shadow: 0 0 10px rgba(147, 51, 234, 0.8),
                         0 0 20px rgba(147, 51, 234, 0.6),
                         0 0 30px rgba(147, 51, 234, 0.4);
        }
        .rate-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .rate-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
        }
        .rate-card:hover::before {
            animation: shimmer 0.5s ease-in-out;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        .rate-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 40px rgba(147, 51, 234, 0.3);
        }
        .chart-container {
            position: relative;
            height: 500px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
        }
        .trade-button {
            background: linear-gradient(45deg, #10b981, #059669);
            transition: all 0.3s ease;
        }
        .trade-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        .candle-green { background: #10b981; }
        .candle-red { background: #ef4444; }
        .volume-bar { background: rgba(147, 51, 234, 0.6); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Animated Background -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute w-96 h-96 bg-purple-600 rounded-full opacity-10 blur-3xl -top-48 -left-48 pulse-animation"></div>
        <div class="absolute w-96 h-96 bg-blue-600 rounded-full opacity-10 blur-3xl -bottom-48 -right-48 pulse-animation" style="animation-delay: 1s;"></div>
    </div>

    <div class="container mx-auto px-4 py-8 relative z-10">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-6xl font-bold neon-glow mb-4">
                <i class="fas fa-chart-line mr-4"></i>BKC EXCHANGE
            </h1>
            <p class="text-xl text-gray-300">Professional Trading Platform</p>
        </header>

        <!-- Main Rate Display -->
        <div class="mb-8">
            <div class="rate-card rounded-2xl p-8 text-center text-white relative">
                <div class="relative z-10">
                    <div class="mb-6">
                        <i class="fas fa-coins text-6xl text-yellow-400 animate-bounce"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-4">REAL-TIME EXCHANGE RATE</h2>
                    <div class="text-6xl font-bold mb-4">
                        <span id="currentRate" class="pulse-animation">1000.00</span>
                        <span class="text-2xl text-gray-300">BKC = 1 USD</span>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div class="glass-morphism rounded-lg p-3">
                            <div class="text-green-400 font-bold" id="change24h">+0.00%</div>
                            <div class="text-gray-400">24h Change</div>
                        </div>
                        <div class="glass-morphism rounded-lg p-3">
                            <div class="text-blue-400 font-bold" id="volume24h">0</div>
                            <div class="text-gray-400">24h Volume</div>
                        </div>
                        <div class="glass-morphism rounded-lg p-3">
                            <div class="text-purple-400 font-bold" id="trades24h">0</div>
                            <div class="text-gray-400">24h Trades</div>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-gray-300">
                        <i class="fas fa-clock mr-2"></i>
                        Last Update: <span id="lastUpdate">--:--:--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Panel -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Buy Panel -->
            <div class="glass-morphism rounded-2xl p-6">
                <h3 class="text-2xl font-bold mb-6 text-green-400">
                    <i class="fas fa-arrow-up mr-2"></i>BUY BKC
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Amount (USD)</label>
                        <input type="number" id="buyAmount" placeholder="100.00" 
                            class="w-full px-4 py-3 bg-gray-800 border border-green-500 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">You will receive</label>
                        <div class="text-2xl font-bold text-green-400" id="buyReceive">0 BKC</div>
                    </div>
                    <button onclick="executeBuy()" 
                        class="trade-button w-full py-4 text-white font-bold rounded-lg text-lg">
                        <i class="fas fa-shopping-cart mr-2"></i>BUY NOW
                    </button>
                </div>
            </div>

            <!-- Sell Panel -->
            <div class="glass-morphism rounded-2xl p-6">
                <h3 class="text-2xl font-bold mb-6 text-red-400">
                    <i class="fas fa-arrow-down mr-2"></i>SELL BKC
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Amount (BKC)</label>
                        <input type="number" id="sellAmount" placeholder="1000.00" 
                            class="w-full px-4 py-3 bg-gray-800 border border-red-500 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">You will receive</label>
                        <div class="text-2xl font-bold text-red-400" id="sellReceive">0 USD</div>
                    </div>
                    <button onclick="executeSell()" 
                        class="w-full py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg text-lg transition-all transform hover:scale-105">
                        <i class="fas fa-money-bill-wave mr-2"></i>SELL NOW
                    </button>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-purple-400">
                    <i class="fas fa-chart-candlestick mr-2"></i>LIVE CANDLESTICK CHART
                </h2>
                <div class="flex space-x-2">
                    <button onclick="changePeriod('1h')" class="period-btn px-4 py-2 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors">1H</button>
                    <button onclick="changePeriod('4h')" class="period-btn px-4 py-2 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors">4H</button>
                    <button onclick="changePeriod('24h')" class="period-btn px-4 py-2 bg-purple-600 rounded-lg transition-colors">24H</button>
                    <button onclick="changePeriod('7d')" class="period-btn px-4 py-2 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors">7D</button>
                    <button onclick="changePeriod('30d')" class="period-btn px-4 py-2 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors">30D</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="candlestickChart"></canvas>
            </div>
        </div>

        <!-- Market Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-morphism rounded-xl p-6 text-center">
                <i class="fas fa-chart-line text-3xl text-green-500 mb-4"></i>
                <h3 class="text-xl font-bold" id="high24h">1050.00</h3>
                <p class="text-gray-400">24h High</p>
            </div>
            <div class="glass-morphism rounded-xl p-6 text-center">
                <i class="fas fa-chart-line text-3xl text-red-500 mb-4"></i>
                <h3 class="text-xl font-bold" id="low24h">950.00</h3>
                <p class="text-gray-400">24h Low</p>
            </div>
            <div class="glass-morphism rounded-xl p-6 text-center">
                <i class="fas fa-chart-bar text-3xl text-blue-500 mb-4"></i>
                <h3 class="text-xl font-bold" id="avg24h">1000.00</h3>
                <p class="text-gray-400">24h Average</p>
            </div>
            <div class="glass-morphism rounded-xl p-6 text-center">
                <i class="fas fa-percentage text-3xl text-purple-500 mb-4"></i>
                <h3 class="text-xl font-bold" id="volatility24h">2.5%</h3>
                <p class="text-gray-400">Volatility</p>
            </div>
        </div>

        <!-- Recent Trades -->
        <div class="glass-morphism rounded-2xl p-6">
            <h2 class="text-2xl font-bold mb-6 text-purple-400">
                <i class="fas fa-history mr-2"></i>RECENT TRADES
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-700">
                            <th class="text-left py-3 px-4">Time</th>
                            <th class="text-left py-3 px-4">Type</th>
                            <th class="text-left py-3 px-4">Amount</th>
                            <th class="text-left py-3 px-4">Price</th>
                            <th class="text-left py-3 px-4">Total</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTable">
                        <!-- Trades will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentRate = 1000.0;
        let candlestickChart = null;
        let currentPeriod = '24h';
        let recentTrades = [];

        // Initialize chart
        function initCandlestickChart() {
            const ctx = document.getElementById('candlestickChart').getContext('2d');
            
            candlestickChart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: 'BKC/USD',
                        data: [],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white',
                                callback: function(value) {
                                    return value.toFixed(2) + ' BKC';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const data = context.raw;
                                    return [
                                        `Open: ${data.o.toFixed(2)}`,
                                        `High: ${data.h.toFixed(2)}`,
                                        `Low: ${data.l.toFixed(2)}`,
                                        `Close: ${data.c.toFixed(2)}`,
                                        `Volume: ${data.v.toFixed(0)}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // Load candlestick data
        async function loadCandlestickData() {
            try {
                const response = await fetch(`/api/v1/exchange/candles?period=${currentPeriod}`);
                const result = await response.json();
                
                if (result.success) {
                    const candleData = result.candles.map(candle => ({
                        x: candle.timestamp,
                        o: candle.open,
                        h: candle.high,
                        l: candle.low,
                        c: candle.close,
                        v: candle.volume
                    }));
                    
                    candlestickChart.data.datasets[0].data = candleData;
                    candlestickChart.update('none');
                }
            } catch (error) {
                console.error('Error loading candlestick data:', error);
                // Generate mock data for demo
                generateMockCandlestickData();
            }
        }

        // Generate mock candlestick data
        function generateMockCandlestickData() {
            const now = new Date();
            const candleData = [];
            
            for (let i = 60; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 60000);
                const basePrice = currentRate;
                const variation = (Math.random() - 0.5) * 20;
                
                const open = basePrice + variation;
                const close = basePrice + variation + (Math.random() - 0.5) * 10;
                const high = Math.max(open, close) + Math.random() * 5;
                const low = Math.min(open, close) - Math.random() * 5;
                const volume = 10000 + Math.random() * 50000;
                
                candleData.push({
                    x: time,
                    o: open,
                    h: high,
                    l: low,
                    c: close,
                    v: volume
                });
            }
            
            candlestickChart.data.datasets[0].data = candleData;
            candlestickChart.update('none');
        }

        // Update current rate
        async function updateCurrentRate() {
            try {
                const response = await fetch('/api/v1/exchange/rate');
                const result = await response.json();
                
                if (result.success) {
                    currentRate = result.rate;
                    document.getElementById('currentRate').textContent = currentRate.toFixed(2);
                    document.getElementById('lastUpdate').textContent = new Date(result.last_update).toLocaleTimeString();
                    document.getElementById('change24h').textContent = 
                        (result.change_pct >= 0 ? '+' : '') + result.change_pct.toFixed(2) + '%';
                    
                    // Update color based on change
                    const changeElement = document.getElementById('change24h');
                    changeElement.className = result.change_pct >= 0 ? 
                        'text-green-400 font-bold' : 'text-red-400 font-bold';
                }
            } catch (error) {
                console.error('Error updating rate:', error);
            }
        }

        // Update market statistics
        async function updateMarketStats() {
            try {
                const response = await fetch('/api/v1/exchange/stats');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.stats;
                    document.getElementById('volume24h').textContent = 
                        (stats.total_volume / 1000000).toFixed(2) + 'M';
                    document.getElementById('trades24h').textContent = 
                        stats.total_trades.toLocaleString();
                    document.getElementById('high24h').textContent = 
                        (currentRate * 1.05).toFixed(2);
                    document.getElementById('low24h').textContent = 
                        (currentRate * 0.95).toFixed(2);
                    document.getElementById('avg24h').textContent = 
                        currentRate.toFixed(2);
                    document.getElementById('volatility24h').textContent = 
                        (result.volatility * 100).toFixed(2) + '%';
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Execute buy trade
        async function executeBuy() {
            const amount = parseFloat(document.getElementById('buyAmount').value);
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            try {
                const response = await fetch('/api/v1/exchange/trade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'buy',
                        amount: amount,
                        currency: 'USD'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    addTradeToHistory(result, 'buy');
                    alert(`Buy order executed! Rate: ${result.price.toFixed(2)} BKC/USD`);
                    document.getElementById('buyAmount').value = '';
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Execute sell trade
        async function executeSell() {
            const amount = parseFloat(document.getElementById('sellAmount').value);
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            try {
                const response = await fetch('/api/v1/exchange/trade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'sell',
                        amount: amount,
                        currency: 'USD'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    addTradeToHistory(result, 'sell');
                    alert(`Sell order executed! Rate: ${result.price.toFixed(2)} BKC/USD`);
                    document.getElementById('sellAmount').value = '';
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Add trade to history
        function addTradeToHistory(trade, type) {
            const tradeRow = {
                time: new Date(trade.timestamp).toLocaleTimeString(),
                type: type.toUpperCase(),
                amount: trade.amount.toFixed(2),
                price: trade.price.toFixed(2),
                total: trade.total.toFixed(2)
            };
            
            recentTrades.unshift(tradeRow);
            if (recentTrades.length > 10) {
                recentTrades = recentTrades.slice(0, 10);
            }
            
            updateTradesTable();
        }

        // Update trades table
        function updateTradesTable() {
            const tbody = document.getElementById('tradesTable');
            tbody.innerHTML = '';
            
            recentTrades.forEach(trade => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-800 hover:bg-gray-800 transition-colors';
                
                const typeColor = trade.type === 'BUY' ? 'text-green-400' : 'text-red-400';
                
                row.innerHTML = `
                    <td class="py-3 px-4">${trade.time}</td>
                    <td class="py-3 px-4">
                        <span class="${typeColor} font-bold">${trade.type}</span>
                    </td>
                    <td class="py-3 px-4">${trade.amount}</td>
                    <td class="py-3 px-4">${trade.price}</td>
                    <td class="py-3 px-4 font-bold">${trade.total}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Change period
        function changePeriod(period) {
            currentPeriod = period;
            
            // Update button styles
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('bg-purple-600');
                btn.classList.add('bg-gray-700');
            });
            event.target.classList.remove('bg-gray-700');
            event.target.classList.add('bg-purple-600');
            
            // Reload chart data
            loadCandlestickData();
        }

        // Update calculations
        document.getElementById('buyAmount').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            const receive = amount * currentRate;
            document.getElementById('buyReceive').textContent = receive.toFixed(2) + ' BKC';
        });

        document.getElementById('sellAmount').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            const receive = amount / currentRate;
            document.getElementById('sellReceive').textContent = '$' + receive.toFixed(2);
        });

        // Auto-update
        function startAutoUpdate() {
            // Update rate every 5 seconds
            setInterval(updateCurrentRate, 5000);
            
            // Update stats every 30 seconds
            setInterval(updateMarketStats, 30000);
            
            // Update chart every minute
            setInterval(loadCandlestickData, 60000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCandlestickChart();
            updateCurrentRate();
            updateMarketStats();
            loadCandlestickData();
            startAutoUpdate();
        });
    </script>
</body>
</html>
