<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BKC Coin - Tap Game</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        .game-container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 300px;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            overflow-y: auto;
        }
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .coin {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            user-select: none;
            position: relative;
        }
        .coin:hover {
            transform: scale(1.05);
        }
        .coin.tapping {
            transform: scale(0.95);
        }
        .tap-effect {
            position: absolute;
            color: #FFD700;
            font-size: 24px;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
        }
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px);
            }
        }
        .stats-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        .stat-label {
            color: rgba(255,255,255,0.8);
        }
        .stat-value {
            font-weight: bold;
        }
        .energy-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00);
            transition: width 0.3s;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f093fb, #f5576c);
            transition: width 0.3s;
        }
        .shop-button {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            color: white;
            cursor: pointer;
            margin: 10px 0;
            width: 100%;
            font-size: 16px;
        }
        .shop-button:hover {
            transform: scale(1.05);
        }
        .nft-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .ton-connect-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 18px;
            z-index: 2000;
            display: none;
        }
        .message.success {
            background: rgba(0,255,0,0.9);
        }
        .message.error {
            background: rgba(255,0,0,0.9);
        }
    </style>
</head>
<body>
    <div class="ton-connect-btn" id="ton-connect-button"></div>
    
    <div class="game-container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar">
            <h2>ü™ô BKC Coin</h2>
            
            <div class="stats-card">
                <h3>üí∞ –ë–∞–ª–∞–Ω—Å</h3>
                <div class="stat-item">
                    <span class="stat-label">BKC:</span>
                    <span class="stat-value" id="balance">0.0</span>
                </div>
            </div>

            <div class="stats-card">
                <h3>‚ö° –≠–Ω–µ—Ä–≥–∏—è</h3>
                <div class="stat-item">
                    <span class="stat-label">–¢–µ–∫—É—â–∞—è:</span>
                    <span class="stat-value" id="energy-current">1000</span>
                </div>
                <div class="energy-bar">
                    <div class="energy-fill" id="energy-fill"></div>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–ú–∞–∫—Å–∏–º—É–º:</span>
                    <span class="stat-value" id="energy-max">1000</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–î–æ—Ö–æ–¥ –∑–∞ —Ç–∞–ø:</span>
                    <span class="stat-value" id="tap-reward">0.1 BKC</span>
                </div>
            </div>

            <div class="stats-card">
                <h3>üéØ –°–µ—Å—Å–∏–∏</h3>
                <div class="stat-item">
                    <span class="stat-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ:</span>
                    <span class="stat-value" id="sessions-used">0/3</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–û—Å—Ç–∞–ª–æ—Å—å:</span>
                    <span class="stat-value" id="sessions-left">3</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–î–æ—Ö–æ–¥ –∑–∞ —Å–µ—Å—Å–∏—é:</span>
                    <span class="stat-value">100 BKC</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç:</span>
                    <span class="stat-value">300 BKC</span>
                </div>
            </div>

            <div class="stats-card">
                <h3>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <div class="stat-item">
                    <span class="stat-label">1 —Å–µ—Å—Å–∏—è = 1000 —Ç–∞–ø–æ–≤</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ = 1 —á–∞—Å</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–õ–∏–º–∏—Ç –≤ –¥–µ–Ω—å = 3 —Å–µ—Å—Å–∏–∏</span>
                </div>
            </div>
        </div>

        <!-- –ò–≥—Ä–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="game-area">
            <div class="coin" id="coin" onclick="tap(event)">
                ü™ô
            </div>
        </div>
    </div>

    <script>
        // TonConnect
        const tonConnectUI = new TonConnectUI({
            manifestUrl: 'https://your-app-url.com/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-button'
        });

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ user_id –∏–∑ Telegram WebApp
        function getUserId() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                const telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
                if (telegramUser && telegramUser.id) {
                    return telegramUser.id;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
            const savedUserId = localStorage.getItem('bkc_user_id');
            if (savedUserId) {
                return parseInt(savedUserId);
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID –¥–ª—è –¥–µ–º–æ
            const tempId = Math.floor(Math.random() * 1000000) + 1000000;
            localStorage.setItem('bkc_user_id', tempId);
            return tempId;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserStatus() {
            try {
                const userId = getUserId();
                const response = await fetch(`/api/v1/tap/status?user_id=${userId}`);
                const result = await response.json();

                if (result.success) {
                    const status = result.user_status;
                    gameState.balance = status.balance;
                    gameState.energyCurrent = status.energy_current;
                    gameState.energyMax = status.energy_max;
                    gameState.dailySessionsUsed = status.daily_sessions_used || 0;
                    gameState.dailySessionsLeft = status.daily_sessions_left || 3;
                    gameState.lastSessionEnd = status.last_session_end;
                    gameState.tapReward = status.tap_reward || 10;

                    updateUI();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–ø–∞
        async function tap(event) {
            if (gameState.isTapping || gameState.energyCurrent < 1) {
                if (gameState.energyCurrent < 1) {
                    if (gameState.dailySessionsLeft <= 0) {
                        showMessage('üö´ –õ–∏–º–∏—Ç —Å–µ—Å—Å–∏–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏—Å—á–µ—Ä–ø–∞–Ω!', 'error');
                    } else {
                        const timeToFull = gameState.lastSessionEnd ? 
                            Math.max(0, 3600000 - (Date.now() - new Date(gameState.lastSessionEnd).getTime())) : 0;
                        if (timeToFull > 0) {
                            const hours = Math.floor(timeToFull / 3600000);
                            const minutes = Math.floor((timeToFull % 3600000) / 60000);
                            showMessage(`‚è∞ –≠–Ω–µ—Ä–≥–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ ${hours}—á ${minutes}–º`, 'error');
                        } else {
                            showMessage('‚ö° –≠–Ω–µ—Ä–≥–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é.', 'success');
                        }
                    }
                }
                return;
            }

            gameState.isTapping = true;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è
            const coin = document.getElementById('coin');
            coin.classList.add('tapping');
            
            // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç
            createTapEffect(event.clientX, event.clientY);

            try {
                const userId = getUserId();
                const response = await fetch('/api/v1/tap/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        timestamp: Date.now()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    gameState.balance = result.new_balance;
                    gameState.energyCurrent = result.current_energy;
                    gameState.dailySessionsLeft = result.daily_sessions_left;

                    updateUI();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Ö–æ–¥ –∑–∞ —Ç–∞–ø
                    const earnings = result.earnings / 100; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ BKC*100
                    showMessage(`+${earnings.toFixed(1)} BKC`, 'success');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ç–∞–ø–∞:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }

            setTimeout(() => {
                coin.classList.remove('tapping');
                gameState.isTapping = false;
            }, 100);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            document.getElementById('balance').textContent = (gameState.balance / 100).toFixed(1);
            document.getElementById('energy-current').textContent = gameState.energyCurrent;
            document.getElementById('energy-max').textContent = gameState.energyMax;
            document.getElementById('tap-reward').textContent = (gameState.tapReward / 100).toFixed(1) + ' BKC';
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π
            const sessionsUsed = 3 - gameState.dailySessionsLeft;
            document.getElementById('sessions-used').textContent = `${sessionsUsed}/3`;
            document.getElementById('sessions-left').textContent = gameState.dailySessionsLeft;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏
            const energyPercent = (gameState.energyCurrent / gameState.energyMax) * 100;
            document.getElementById('energy-fill').style.width = energyPercent + '%';
            
            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —ç–Ω–µ—Ä–≥–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            const energyFill = document.getElementById('energy-fill');
            if (energyPercent > 50) {
                energyFill.style.background = 'linear-gradient(90deg, #00ff00, #ffff00)';
            } else if (energyPercent > 20) {
                energyFill.style.background = 'linear-gradient(90deg, #ffff00, #ff8800)';
            } else {
                energyFill.style.background = 'linear-gradient(90deg, #ff8800, #ff0000)';
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ç–∞–ø–∞
        function createTapEffect(x, y) {
            const effect = document.createElement('div');
            effect.className = 'tap-effect';
            effect.textContent = `+${(gameState.tapReward / 100).toFixed(1)}`;
            effect.style.left = x + 'px';
            effect.style.top = y + 'px';
            document.body.appendChild(effect);

            setTimeout(() => {
                effect.remove();
            }, 1000);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type = 'success') {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            message.style.display = 'block';
            document.body.appendChild(message);

            setTimeout(() => {
                message.remove();
            }, 2000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        const gameState = {
            balance: 0,
            energyCurrent: 1000,
            energyMax: 1000,
            dailySessionsUsed: 0,
            dailySessionsLeft: 3,
            lastSessionEnd: null,
            tapReward: 10, // 0.1 BKC * 100
            isTapping: false
        };

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window.addEventListener('load', () => {
            loadUserStatus();
            setInterval(loadUserStatus, 30000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        });

    </script>
</body>
</html>
